@model ChessModel.Game

@Html.Partial("game", Model)

@using (Ajax.BeginForm("show", null,
    new AjaxOptions
    {
        HttpMethod = "get",
        InsertionMode = InsertionMode.Replace,
        UpdateTargetId = "gameHolder"
    },
    new { id = "refreshForm" }))
{
    <input type="hidden" name="id" value="@Model.Id"/>
}

@using (Ajax.BeginForm("MakeMove", null,
                    new AjaxOptions
                    {
                        HttpMethod = "post",
                        InsertionMode = InsertionMode.Replace,
                        UpdateTargetId = "gameHolder"                        
                    },
                    new { id = "makeMove" }))
{
    <input type="hidden" name="id" value="@Model.Id" />
    <input type="hidden" name="move" value="" />
}

@section Scripts{
<script type="text/javascript">
    function makeDraggable() {
        $('.movable').draggable({
            containment: "table",
            revert: 'invalid'
        });

        $('.square').droppable({
            drop: function (ev, ui) {
                var dropped = ui.draggable;
                var droppedOn = $(this);

                if ($(dropped).attr("data-move-to").indexOf(droppedOn.attr("id")) >= 0) {

                    var moveForm = document.forms["makeMove"];
                    moveForm.elements["move"].value = $(dropped).parent().attr("id") + "-" + droppedOn.attr("id");
                    $(moveForm).submit();
                }
                else {
                    $(dropped).css({ top: 0, left: 0 })
                }
            }
        });
    }

    makeDraggable();
    var myVar = setInterval(function () { refreshBoard() }, 333);

    function refreshBoard() {
        if (doRefresh)
            $(document.getElementById('refreshForm')).submit();
    }

</script>
}